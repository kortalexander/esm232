---
title: "Assignment 4"
author: "Kort Alexander and Grace Bianchi"
date: "2023-05-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(sensitivity)
library(lhs)
```

```{r}
# source conductance function
source(here("R", "Catm.R"))

# set parameters
pnames <- c("height", "k_d", "k_o", "v")
npar <- length(pnames)
nsample <- 100

# Use the Latin hypercube approach to generate parameter values for the 4 parameters
parm_quant <- randomLHS(nsample, npar)
colnames(parm_quant) <- pnames

parm = as.data.frame(matrix(nrow=nrow(parm_quant), ncol=ncol(parm_quant)))
colnames(parm) = pnames

percent_k_d_0 <- 0.01
parm[,"height"] = qunif(parm_quant[,"height"], min = 9.5, max = 10.5)
parm[,"k_d"] = qnorm(parm_quant[, "k_d"], mean = 0.7, sd = 0.7 * percent_k_d_0)
parm[,"k_o"] = qnorm(parm_quant[, "k_o"], mean = 0.1, sd = 0.1 * percent_k_d_0)
parm[, "v"] = qnorm(parm_quant[, "v"], mean = 250, sd = 30)
```

```{r}
# run our model for all of the parameters generated by LHS
results = pmap(.l=parm, .f=Catm)
# convert list to df and add Ca values into rows
results_df <- as.data.frame(do.call(rbind, results)) %>% 
  rename(conductance = V1) %>% 
  cbind(parm) # add parameter values

# make boxplot showing range of conductance values accounting for parameter uncertainty
ggplot(results_df, aes(y = conductance)) +
  geom_boxplot() +
  labs(y = "Atmospheric conductance (mm/s)") +
  theme(legend.position = "none", 
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

# tidy version for graphing
results_long <- results_df %>%
  gather(v, height, k_o, k_d, key = "parameter", value = "value")

# labels for facet wrap
parm_labs <- c("height", "plane displacement scalar", "roughness scalar", "windspeed")
names(parm_labs)  <- c("height", "k_d", "k_o", "v")
```

Figure 1. Boxplot of atmospheric conductance accounting for parameter uncertainty.


```{r}
# make scatterplots showing conductance values vs each parameter
ggplot(results_long, aes(y = conductance, x = value, color = parameter)) +
  geom_point() +
  facet_wrap(~parameter, scales = "free", labeller = labeller(parameter = parm_labs)) +
  labs(x = "Parameter value", y = "Atmospheric conductance (mm/s)") +
  theme(legend.position = "none")
```

Figure 2. Plots of atmospheric conductance vs each parameter. Uncertainty in windspeed has the greatest effect on variance in conductance.

```{r}
# calculate partial rank correlation coefficients for each parameter
corr_coeffs = pcc(parm, results_df$conductance)
corr_coeffs
```

# Conclusion
Our results suggest the variance in aerodynamic conductance is most affected by uncertainty in wind speed, but uncertainty in vegetation height and roughness also have a large effect. To reduce uncertainty in conductance estimates, you should reduce uncertainty in wind speed, vegetation height, and roughness. Because plant water use is related to aerodynamic conductance, plant water use could be affected by climate change if wind speed changes significantly as a result.
