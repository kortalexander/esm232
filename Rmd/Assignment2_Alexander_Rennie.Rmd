---
title: "Assignment 2"
author: "Kort Alexander, Zoe Rennie"
date: "2023-04-20"
output: 
  html_document:
    theme: darkly
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(dplyr.summarise.inform = FALSE)
library(here)
library(dplyr)
library(knitr)
```

## Conceptual Model

![Yield Anomalies Model Diagram](almond_function_diagram.png)

## Climate Data Function

Below is implementation of the function almond_yield to obtain the minimum, maximum, and mean almond yield anomalies.

```{r}
#' Calculate the maximum, minimum, and mean almond yield anomaly for a given time series.
#' 
#' @param clim_data Data frame of daily climate data for time period of interest. Columns: day, month, year, wy, tmax_c, tmin_c, precip.
#' @returns List of max, min, and mean almond yield anomalies.
#' 

almond_yield <- function(clim_data) {
  
  # process climate data into monthly averages
  clim_monthly <- clim_data %>% 
    group_by(year, month) %>% 
    summarize(tmax = mean(tmax_c), tmin = min(tmin_c), total_precip = sum(precip))
  
  # get years of interest and loop through them
  years = unique(clim_monthly$year)
  yield_anomalies <- list()
  for(i in min(years):max(years)) {
    
    # filter data for each year
    year_i_data <- clim_monthly %>% 
      filter(year == i)
    
    # skip year if there's no data for the months needed
    if(!(1 %in% year_i_data$month) | !(2 %in% year_i_data$month)) {
      next
    }
    
    # extract needed values by referencing the row and column and input into formula
    yield_anomaly_i <- -0.015 * (year_i_data[year_i_data$month==2, ][[4]]) -
      0.0046 * (year_i_data[year_i_data$month==2, ][[4]])^2 -
      0.07 * (year_i_data[year_i_data$month==1, ][[5]]) +
      0.0043 * (year_i_data[year_i_data$month==1, ][[5]])^2 +
      0.28
    
    # add to list of anomalies
    yield_anomalies <- yield_anomalies %>% append(yield_anomaly_i)
  }
  
  # unlist anomalies and return max, min, and mean
  yield_anomalies <- unlist(yield_anomalies)
  return(list(max_yield_anomaly = max(yield_anomalies), min_yield_anomaly = min(yield_anomalies), mean_yield_anomaly = mean(yield_anomalies)))
}

#test function
clim_data <- as.data.frame(read.table(here("data","clim.txt"), header=T))
almond_yield(clim_data)
```
